#!perl

use strict;
use Getopt::Long;
use Pod::Usage qw(pod2usage);
use Carp qw(croak);
use FindBin;
use File::Basename qw(basename);
use Data::Dump qw(dump);

use Conform;
use Conform::Agent;
use Conform::Runtime;
use Conform::Site;
use Conform::Config;
use Conform::Debug;
use Conform::Logger qw($log);
use Conform::Runtime::Server::Posix;
use Conform::SiteLoader;

# Conform::Logger->set('Stderr');

my @debug;
my @trace;

my $iam;
my $uri;
my $conf_file = "$FindBin::Bin/../etc/conform.ini";
my $runtime_name;
my @list;


sub usage {
	my %args = @_;
	pod2usage %args;
}

GetOptions(
    'iam=s'         => \$iam,
	'uri=s'         => \$uri,
	'runtime'       => \$runtime_name,
    'conf-file=s'   => \$conf_file,
    'trace'         => \$Conform::Debug::TRACE,
    'debug'         => \$Conform::Debug::DEBUG,
    'list=s'        => \@list,
	'h|?'           => \&usage
) or usage(msg => 'Invalid parametes');

Conform::Config->set(files => [$conf_file]);

my $config = Conform::Config->get_config(for => basename $0);

if ($config and ref $config eq 'HASH') {
    for (keys %$config) {
        /iam/     and do { $iam          ||= $config->{$_} };
        /runtime/ and do { $runtime_name ||= $config->{$_} };
        /uri/     and do { $uri          ||= $config->{$_} };
        /trace/   and do { $Conform::Debug::TRACE = $config->{$_} };
        /debug/   and do { $Conform::Debug::DEBUG = $config->{$_} };
    }
}

eval "use ${runtime_name};";
if (my $err = $@) {
    print "Error loading ${runtime_name}: $err $!\n";
    exit;
}

usage (msg => 'missing runtime, or uri')
    unless $runtime_name && $uri;

my $runtime = $runtime_name->new(iam => $iam); 
if (@list) {

    $runtime->boot;

    for (@list) {
        /^plugins$/ and do {
            printf "%s Action Providers VERSION = %s, ID = %s\n",
                   $runtime->getName(),
                   $runtime->getVersion() || 0,
                   $runtime->getId();

            for my $provider (@{$runtime->action_providers}) {
                printf "%s %s %s %s %s\n",
                        $provider->getId(),
                        $provider->id(),
                        $provider->name(),
                        $provider->getVersion(),
                        $provider->get_attr('Desc');

            }
        };
    }
    exit 0;
}


my $site    = Conform::SiteLoader->load($uri);
my $agent   = Conform::Agent->new(site => $site, runtime => $runtime);

$agent->conform();


__END__

=head1	NAME

conform

=cut

=head1  SYNOPSIS

    conform [-c /etc/conform.conf]

=cut


# vi: set ts=4 sw=4:
# vi: set expandtab:
